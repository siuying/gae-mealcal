<html>
	<head>
		<title>買餐計價</title>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.js"></script>
  		<script type='text/javascript' src='./dwr/engine.js'> </script>
  		<script type='text/javascript' src='./dwr/interface/OrderMaker.js'> </script>
		<script type="text/javascript" src="meal_calculator.js"></script>
		<link rel="stylesheet" href="meal.css" />
		<script type="text/javascript">
			var mealController = {
			    menu: {
			        foods: {},
			        meals: {}
			    },

			    init: function() {
			        var controller = mealController;

			        $("#find").click(function() {
			            controller.findOrder();
			        });

			        $("#clear").click(function() {
			            controller.clearSelection();
			        });

			        OrderMaker.getFoodMenu(function(data) {
			            controller.menu.foods = data;
			            OrderMaker.getMealMenu(function(data) {
			                controller.menu.meals = data;
			                controller.loadMenu();
			            });
			        });
			    },

			    loadMenu: function() {
			        var menu = this.getMenu();

			        // Init food
			        var foods = [];
			        for (var f in menu.foods) {
			            foods.push(f);
			        }
			        var html = $.map(foods, function(n, i) {
			            return '<a class="food" href="#">' + n + '</a>($' + menu.foods[f].price + ')';
			        }).join(",");

			        // Populate food items
			        $("#availableFoods")
						.html(html)
			        	.click(function(e) {
				            var t = $(e.target);
				            if (t.is("a")) {
				                var copy = t.clone();
				                $("<span/>")
				                .append(copy)
				                .append("<a class='close' href='#'>x</a>")
				                .appendTo("#selected")
				                .click(function() {
				                    $(this).remove();
				                    return false;
				                });
				            }
				            return false;
				        });
			    },

			    findOrder: function() {
			        var menu = this.getMenu();

			        // User Selection
			        var selected = [];
			        $("#selected a.food").each(function() {
			            selected.push($(this).text());
			        });

			        // Delegate to remote order maker
			        OrderMaker.makeOrder(selected, function(items) {
			            // reporting
			            var outputHtml = "";
			            var total = 0;
			            for (var i in items) {
			                var item = menu.foods[items[i]] || menu.meals[items[i]];
			                if (item) {
			                    outputHtml += "<li>" + items[i] + " ($" + item.price + ") </li>";
			                    total += item.price;
			                }
			            }

			            if (outputHtml) outputHtml = '<ul>' + outputHtml + '</ul>';
			            outputHtml += '<p class="total">總額: $' + Math.round(total * 1000) / 1000 + '</p>';
			            $("#output").html(outputHtml);
			            $("#suggestion").show();
			        });
			    },

			    clearSelection: function(menu) {
			        $("#selected").html("");
			        $("#output").html("");
			        $("#suggestion").hide();
			        return false;
			    },

			    getMenu: function() {
			        return this.menu;
			    },
			};

			// run when DOM ready
			$(document).ready(function() {
			    mealController.init();
			});
		</script>
	</head>
	<body>
	
		<h1>買餐計價 @ GAE</h1>
		
		<div class="section">
			<h2>點擊加入食物:</h2>
			<div id="availableFoods"></div>
		</div>
		
		<div class="section">
			<h2>已選食物:</h2>
			<div id="selected"></div>
		
			<input type="button" value="計算組合!" id="find"/>
			<a href="#" id="clear">清除</a>
		</div>
		
		<div class="section" id="suggestion">
			<h2>建議購買組合:</h2>
			<div id="output"></div>
		</div>

		<div class="footnote">
			<p>Based on javascript implementation by <a href="http://jackysee.github.com/mealcalculator/meal_calculator.html">jackysee</a>. Backed by Java <a href="http://github.com/siuying/quiz1/tree/master">implementations</a> with GAE + DWR + Spring. Details <a href="http://www.reality.hk/articles/2009/04/19/929/">here</a></p>
			<p>Source code at <a href="http://github.com/siuying/gae-mealcal/tree/master">github</a> @ <a href="http://twitter.com/siuying">siuying</a></p>
		</div>
	</body>
</html>
